<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horn Pitch Master Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #f1f5f9;
            font-family: system-ui, -apple-system, sans-serif;
            touch-action: manipulation;
            user-select: none;
        }
        .active-note {
            background-color: #f59e0b !important;
            color: #0f172a !important;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
        }
        .active-octave {
            border-color: #f59e0b !important;
            color: #f59e0b !important;
            background-color: rgba(245, 158, 11, 0.15);
        }
        input[type=range] {
            accent-color: #f59e0b;
        }
        .staff-bg {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        }
        .fingering-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #334155;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.2s;
        }
        .valve-pressed {
            background-color: #f59e0b;
            border-color: #f59e0b;
            color: #0f172a;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.4);
        }
        .toggle-active {
            background-color: #f59e0b;
            color: #0f172a;
            font-weight: bold;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 lg:p-8">

    <div class="flex flex-col lg:flex-row gap-6 items-stretch max-w-5xl w-full">
        
        <div class="flex-1 bg-slate-800 rounded-3xl p-6 shadow-2xl border border-slate-700">
            <header class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-xl font-bold text-amber-500">Horn Pitch Master</h1>
                    <p class="text-slate-400 text-[10px] uppercase tracking-widest font-bold">Horn in F â€¢ Pro Reference</p>
                </div>
                <div class="text-right">
                    <div id="noteDisplay" class="text-3xl font-black text-white leading-none">C4</div>
                    <div id="concertDisplay" class="text-amber-500/80 text-[10px] font-mono mt-1">Sounds Concert F3</div>
                </div>
            </header>

            <!-- Staff Display Area -->
            <div class="text-center mb-6 staff-bg rounded-2xl py-4 border border-slate-600 relative overflow-hidden shadow-inner">
                <div id="staffDisplay" class="flex justify-center items-center min-h-[400px]"></div>
                
                <!-- Bass Clef Mode Toggle -->
                <div id="bassModeControls" class="absolute bottom-4 left-1/2 -translate-x-1/2 hidden">
                    <div class="flex bg-slate-900/80 p-1 rounded-lg border border-slate-700 text-[9px] uppercase tracking-tighter">
                        <button onclick="setBassMode('transposed')" id="btn-transposed" class="px-3 py-1 rounded-md toggle-active">Transposed F (Bass)</button>
                        <button onclick="setBassMode('concert')" id="btn-concert" class="px-3 py-1 rounded-md ml-1">Concert Pitch (Bass)</button>
                    </div>
                </div>
            </div>

            <button id="toggleBtn" class="w-full py-6 rounded-2xl bg-amber-600 hover:bg-amber-500 transition-all font-bold text-xl mb-6 flex items-center justify-center gap-3 text-slate-900 shadow-lg active:scale-95 touch-none">
                <span id="btnText">Start Tone</span>
            </button>

            <div class="space-y-2 mb-6">
                <div class="grid grid-cols-7 gap-1">
                    <button onclick="updateNote('C')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">C</button>
                    <button onclick="updateNote('C#')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">C#</button>
                    <button onclick="updateNote('D')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">D</button>
                    <button onclick="updateNote('D#')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">D#</button>
                    <button onclick="updateNote('E')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">E</button>
                    <button onclick="updateNote('F')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">F</button>
                    <button onclick="updateNote('F#')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">F#</button>
                </div>
                <div class="grid grid-cols-5 gap-1">
                    <button onclick="updateNote('G')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">G</button>
                    <button onclick="updateNote('G#')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">G#</button>
                    <button onclick="updateNote('A')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">A</button>
                    <button onclick="updateNote('A#')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">A#</button>
                    <button onclick="updateNote('B')" class="note-key bg-slate-700 py-3 rounded-lg text-sm">B</button>
                </div>
            </div>

            <div class="flex gap-2 mb-6">
                <button onclick="updateOctave(2)" class="oct-key flex-1 border border-slate-600 py-2 rounded-xl text-[10px] uppercase">Low (2)</button>
                <button onclick="updateOctave(3)" class="oct-key flex-1 border border-slate-600 py-2 rounded-xl text-[10px] uppercase">Mid (3)</button>
                <button onclick="updateOctave(4)" class="oct-key flex-1 border border-slate-600 py-2 rounded-xl text-[10px] uppercase">High (4)</button>
                <button onclick="updateOctave(5)" class="oct-key flex-1 border border-slate-600 py-2 rounded-xl text-[10px] uppercase">Alt (5)</button>
            </div>

            <div class="space-y-4 bg-slate-900/80 p-4 rounded-2xl border border-slate-700">
                <div class="flex flex-col gap-3">
                    <div class="flex justify-between items-center px-1">
                        <span class="text-[10px] text-slate-400 uppercase font-bold">Timbre (Filter)</span>
                        <span id="filterVal" class="text-[10px] font-mono text-amber-400">Warm Resonance</span>
                    </div>
                    <input type="range" id="filterSlider" min="150" max="2500" step="1" value="750" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="flex justify-between items-center px-1 border-t border-slate-800 pt-3">
                    <span id="freqDisplay" class="text-[10px] font-mono text-slate-500 italic">174.61 Hz</span>
                    <span id="labelDisplay" class="text-[10px] font-mono text-amber-500/50">C4 (Written)</span>
                </div>
            </div>
        </div>

        <!-- Fingering Panel -->
        <div class="w-full lg:w-64 bg-slate-800/50 rounded-3xl p-6 border border-slate-700/50 backdrop-blur-sm flex flex-col justify-center">
            <h2 class="text-amber-500/50 text-xs font-bold uppercase tracking-widest text-center mb-6">Valve Fingerings</h2>
            <div class="mb-10 text-center">
                <span class="text-[10px] text-slate-500 font-bold uppercase block mb-3">F Side</span>
                <div class="flex justify-center gap-3">
                    <div id="v-f-1" class="fingering-circle">1</div>
                    <div id="v-f-2" class="fingering-circle">2</div>
                    <div id="v-f-3" class="fingering-circle">3</div>
                </div>
                <div id="f-text" class="text-xs text-slate-400 mt-2 font-mono">Open</div>
            </div>
            <div class="text-center">
                <span class="text-[10px] text-slate-500 font-bold uppercase block mb-3">Bb Side (Thumb)</span>
                <div class="flex justify-center gap-3">
                    <div id="v-bb-t" class="fingering-circle">T</div>
                    <div id="v-bb-1" class="fingering-circle">1</div>
                    <div id="v-bb-2" class="fingering-circle">2</div>
                    <div id="v-bb-3" class="fingering-circle">3</div>
                </div>
                <div id="bb-text" class="text-xs text-slate-400 mt-2 font-mono">T-Open</div>
            </div>
        </div>
    </div>

    <script>
        let audioCtx, oscillator, gainNode, filterNode, hornWave;
        let isPlaying = false;
        let currentNote = "C";
        let currentOctave = 4;
        let bassMode = 'transposed';

        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const trebleMap = { "C":-6, "C#":-6, "D":-5, "D#":-5, "E":-4, "F":-3, "F#":-3, "G":-2, "G#":-2, "A":-1, "A#":-1, "B":0 };
        const bassMap = { "C":-1, "C#":-1, "D":0, "D#":0, "E":1, "F":2, "F#":2, "G":3, "G#":3, "A":4, "A#":4, "B":5 };

        const fingeringMap = {
            "C2": { f: "13", bb: null }, "C#2": { f: "123", bb: null }, "D2": { f: "12", bb: null }, "D#2": { f: "23", bb: null }, "E2": { f: "12", bb: null }, "F2": { f: "1", bb: null }, "F#2": { f: "2", bb: null }, "G2": { f: "0", bb: null }, "G#2": { f: "23", bb: null }, "A2": { f: "12", bb: null }, "A#2": { f: "1", bb: null }, "B2": { f: "2", bb: null },
            "C3": { f: "0", bb: null }, "C#3": { f: "123", bb: null }, "D3": { f: "13", bb: null }, "D#3": { f: "23", bb: null }, "E3": { f: "12", bb: null }, "F3": { f: "1", bb: "T12" }, "F#3": { f: "2", bb: "T23" }, "G3": { f: "0", bb: "T0" }, "G#3": { f: "23", bb: "T23" }, "A3": { f: "12", bb: "T12" }, "A#3": { f: "1", bb: "T1" }, "B3": { f: "2", bb: "T2" },
            "C4": { f: "0", bb: "T0" }, "C#4": { f: "12", bb: "T23" }, "D4": { f: "1", bb: "T12" }, "D#4": { f: "2", bb: "T1" }, "E4": { f: "0", bb: "T2" }, "F4": { f: "1", bb: "T0" }, "F#4": { f: "2", bb: "T2" }, "G4": { f: "0", bb: "T1" }, "G#4": { f: "23", bb: "T2" }, "A4": { f: "12", bb: "T0" }, "A#4": { f: "1", bb: "T1" }, "B4": { f: "2", bb: "T2" },
            "C5": { f: "0", bb: "T0" }, "C#5": { f: "12", bb: "T23" }, "D5": { f: "1", bb: "T12" }, "D#5": { f: "2", bb: "T1" }, "E5": { f: "0", bb: "T2" }, "F5": { f: "1", bb: "T0" }, "F#5": { f: "2", bb: "T2" }, "G5": { f: "0", bb: "T0" }, "G#5": { f: "23", bb: "T23" }, "A5": { f: "12", bb: "T12" }, "A#5": { f: "1", bb: "T1" }, "B5": { f: "2", bb: "T2" }
        };

        function getFrequency(note, octave) {
            const noteIndex = notes.indexOf(note);
            const semitonesFromA4 = (noteIndex - 9) + (octave - 4) * 12 - 7;
            return 440 * Math.pow(2, semitonesFromA4 / 12);
        }

        function getConcertInfo(note, octave) {
            const index = notes.indexOf(note);
            const concertIndex = (index - 7 + 12) % 12;
            const shift = (index < 7) ? -1 : 0;
            return { name: notes[concertIndex], octave: octave + shift };
        }

        function setBassMode(mode) {
            bassMode = mode;
            document.getElementById('btn-transposed').className = `px-3 py-1 rounded-md ${mode === 'transposed' ? 'toggle-active' : ''}`;
            document.getElementById('btn-concert').className = `px-3 py-1 rounded-md ml-1 ${mode === 'concert' ? 'toggle-active' : ''}`;
            drawStaff();
        }

        function renderStaffGroup(svg, clefType, centerY, note, octave, mode) {
            const step = 8;
            let pos;
            
            if (clefType === 'treble') {
                pos = trebleMap[note] + (octave - 4) * 7;
            } else {
                if (mode === 'transposed') {
                    // Written pitch for Horn in F
                    pos = bassMap[note] + (octave - 3) * 7;
                } else {
                    // Concert Pitch
                    const concert = getConcertInfo(note, octave);
                    pos = bassMap[concert.name] + (concert.octave - 3) * 7;
                }
            }

            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            
            // Staff Lines
            for (let i = -2; i <= 2; i++) {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", "10");
                line.setAttribute("y1", centerY + i * (step * 2));
                line.setAttribute("x2", "170");
                line.setAttribute("y2", centerY + i * (step * 2));
                line.setAttribute("stroke", "#475569");
                line.setAttribute("stroke-width", "1");
                g.appendChild(line);
            }

            // Clef Symbol
            const clef = document.createElementNS("http://www.w3.org/2000/svg", "text");
            clef.setAttribute("x", "15");
            clef.setAttribute("y", clefType === 'treble' ? centerY + 32 : centerY + 20);
            clef.setAttribute("fill", "#94a3b8");
            clef.setAttribute("font-size", "80");
            clef.setAttribute("font-family", "serif");
            clef.textContent = clefType === 'treble' ? "ð„ž" : "ð„¢";
            g.appendChild(clef);

            // Dynamic Ledger Lines
            const noteY = centerY - pos * step;
            const drawLedger = (p) => {
                const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
                l.setAttribute("x1", "70");
                l.setAttribute("y1", centerY - p * step);
                l.setAttribute("x2", "110");
                l.setAttribute("y2", centerY - p * step);
                l.setAttribute("stroke", "white");
                l.setAttribute("stroke-width", "1.5");
                g.appendChild(l);
            };

            // Calculate ledger lines: starting from outside the staff (-4 to 4 are staff positions)
            if (pos >= 6) {
                for (let i = 6; i <= pos; i += 2) drawLedger(i);
            } else if (pos <= -6) {
                for (let i = -6; i >= pos; i -= 2) drawLedger(i);
            }

            // Accidental
            if (note.includes("#")) {
                const acc = document.createElementNS("http://www.w3.org/2000/svg", "text");
                acc.setAttribute("x", "52");
                acc.setAttribute("y", noteY + 10);
                acc.setAttribute("fill", "#f59e0b");
                acc.setAttribute("font-size", "32");
                acc.textContent = "â™¯";
                g.appendChild(acc);
            }

            // Note Head
            const head = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
            head.setAttribute("cx", "90");
            head.setAttribute("cy", noteY);
            head.setAttribute("rx", "9");
            head.setAttribute("ry", "7");
            head.setAttribute("fill", "white");
            head.setAttribute("transform", `rotate(-20, 90, ${noteY})`);
            g.appendChild(head);

            // Stem
            const stem = document.createElementNS("http://www.w3.org/2000/svg", "line");
            const stemDirection = pos >= 0 ? 1 : -1;
            const stemX = stemDirection === 1 ? 83 : 97;
            stem.setAttribute("x1", stemX);
            stem.setAttribute("y1", noteY);
            stem.setAttribute("x2", stemX);
            stem.setAttribute("y2", noteY + stemDirection * 50);
            stem.setAttribute("stroke", "white");
            stem.setAttribute("stroke-width", "2");
            g.appendChild(stem);

            return g;
        }

        function drawStaff() {
            const container = document.getElementById('staffDisplay');
            container.innerHTML = "";
            const isLow = currentOctave < 4;
            document.getElementById('bassModeControls').classList.toggle('hidden', !isLow);

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            const viewHeight = isLow ? 420 : 250;
            svg.setAttribute("width", "180");
            svg.setAttribute("height", viewHeight);
            svg.setAttribute("viewBox", `0 0 180 ${viewHeight}`);

            if (!isLow) {
                svg.appendChild(renderStaffGroup(svg, 'treble', 125, currentNote, currentOctave));
            } else {
                // Grand Staff: Treble on top, Bass on bottom
                svg.appendChild(renderStaffGroup(svg, 'treble', 100, currentNote, currentOctave));
                svg.appendChild(renderStaffGroup(svg, 'bass', 280, currentNote, currentOctave, bassMode));
            }
            container.appendChild(svg);
        }

        function updateFingerings(note, octave) {
            const data = fingeringMap[note + octave] || { f: "0", bb: "T0" };
            const setValves = (prefix, valStr) => {
                ['1', '2', '3'].forEach(v => {
                    const el = document.getElementById(`v-${prefix}-${v}`);
                    el.classList.toggle('valve-pressed', valStr && valStr.includes(v));
                });
                if (prefix === 'bb') {
                    document.getElementById('v-bb-t').classList.toggle('valve-pressed', valStr && valStr.includes('T'));
                }
                const textEl = document.getElementById(`${prefix}-text`);
                if (!valStr) textEl.textContent = "N/A";
                else {
                    let readable = valStr.replace('T', 'T-').replace('0', 'Open');
                    if (readable === 'T-') readable = 'T-Open';
                    textEl.textContent = readable;
                }
            };
            setValves('f', data.f);
            setValves('bb', data.bb);
        }

        function updateDisplay() {
            const freq = getFrequency(currentNote, currentOctave);
            const concert = getConcertInfo(currentNote, currentOctave);
            document.getElementById('noteDisplay').textContent = currentNote + currentOctave;
            document.getElementById('concertDisplay').textContent = `Sounds Concert ${concert.name}${concert.octave}`;
            document.getElementById('freqDisplay').textContent = `${freq.toFixed(2)} Hz`;
            document.getElementById('labelDisplay').textContent = `${currentNote}${currentOctave} (Written)`;
            document.querySelectorAll('.note-key').forEach(btn => btn.classList.toggle('active-note', btn.textContent === currentNote));
            document.querySelectorAll('.oct-key').forEach(btn => btn.classList.toggle('active-octave', btn.textContent.includes(currentOctave)));
            drawStaff();
            updateFingerings(currentNote, currentOctave);
            if (oscillator && isPlaying) oscillator.frequency.setTargetAtTime(freq, audioCtx.currentTime, 0.05);
        }

        function updateNote(n) { currentNote = n; updateDisplay(); }
        function updateOctave(o) { currentOctave = o; updateDisplay(); }

        function toggleAudio() {
            if (isPlaying) {
                if (oscillator) {
                    gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.08);
                    const oldOsc = oscillator;
                    setTimeout(() => { try { oldOsc.stop(); oldOsc.disconnect(); } catch(e){} }, 200);
                    oscillator = null;
                }
                isPlaying = false;
            } else {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    gainNode = audioCtx.createGain();
                    filterNode = audioCtx.createBiquadFilter();
                    filterNode.type = "lowpass";
                    filterNode.frequency.value = document.getElementById('filterSlider').value;
                    filterNode.Q.value = 1.8;
                    filterNode.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    const real = new Float32Array([0, 1.0, 0.9, 0.7, 0.5, 0.3, 0.15, 0.08, 0.04, 0.02]);
                    const imag = new Float32Array(real.length).fill(0);
                    hornWave = audioCtx.createPeriodicWave(real, imag);
                }
                if (audioCtx.state === 'suspended') audioCtx.resume();
                oscillator = audioCtx.createOscillator();
                oscillator.setPeriodicWave(hornWave);
                oscillator.frequency.setValueAtTime(getFrequency(currentNote, currentOctave), audioCtx.currentTime);
                oscillator.connect(filterNode);
                oscillator.start();
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.35, audioCtx.currentTime + 0.1);
                isPlaying = true;
            }
            document.getElementById('btnText').textContent = isPlaying ? "Stop Tone" : "Start Drone";
            document.getElementById('toggleBtn').className = `w-full py-6 rounded-2xl ${isPlaying ? 'bg-red-600 hover:bg-red-500' : 'bg-amber-600 hover:bg-amber-500'} transition-all font-bold text-xl mb-6 flex items-center justify-center gap-3 text-slate-900 shadow-lg active:scale-95 touch-none`;
        }

        document.getElementById('toggleBtn').addEventListener('click', toggleAudio);
        document.getElementById('filterSlider').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            if (filterNode) filterNode.frequency.setTargetAtTime(val, audioCtx.currentTime, 0.1);
            const label = document.getElementById('filterVal');
            if (val < 500) label.textContent = "Dark / Muffled";
            else if (val < 1000) label.textContent = "Warm Resonance";
            else if (val < 1800) label.textContent = "Open / Brassy";
            else label.textContent = "Stopped / Piercing";
        });

        window.onload = updateDisplay;
        document.body.addEventListener('touchstart', () => { if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }, { once: true });
    </script>
</body>
</html>
